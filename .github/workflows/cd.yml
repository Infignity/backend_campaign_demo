name: CD Pipeline

on:
  workflow_run:
    workflows: [ "Continuous Integration" ]
    types:
      - completed

jobs:


  build:
    runs-on: self-hosted

    services:
      redis:
        image: redis

    steps:
    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SHH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}

      # - name: Delete old docker campaign images
      #   run: |
      #     sudo docker stop campaign_celery || true
      #     sudo docker rm campaign_celery || true
      #     sudo docker rmi ${{ secrets.DOCKER_USERNAME }}/campaign_celery:lastest || true
      #   continue-on-error: true

      # - name: Delete old docker Celery images
        run: |
          sudo docker stop campaign_demo || true
          sudo docker rm campaign_demo || true
          sudo docker rmi ${{ secrets.DOCKER_USERNAME }}/campaign_demo:lastest || true
          sudo docker pull ${{ secrets.DOCKER_USERNAME }}/campaign_demo:lastest
          cd demo && docker compose up -d
        # continue-on-error: true

      # - name: Pull the Docker Campaign Celery Images
      #   run: sudo docker pull ${{ secrets.DOCKER_USERNAME }}/campaign_celery:lastest

      # - name: Pull the Docker Celery Demo Images
      #   run: sudo docker pull ${{ secrets.DOCKER_USERNAME }}/campaign_demo:lastest

      # - name: Run the images
      #   run: cd demo && docker compose up -d
